<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> -->
    <script type="text/javascript" src="http://pastebin.com/raw.php?i=12fqKKBp"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script> -->
</head>
<body>
    <!-- Slider Drag -->

    <div id="slider" style=""></div><br/>

<select id="hdr_select">
    <option value="lin">Linear</option>
    <option value="gamma20">Gamma 2.0</option>
    <option value="reinhart2002">Reinhart 2002</option>
</select>
<label><input type="checkbox" id="rmz" value="1" checked="checked"/>Remove zeros from LDR histogram</label>
<br/>

<div style="width:1000px;">
<canvas id="histogramhdr" width="580" height="60" style="border:1px solid #d3d3d3; vertical-align: top;">
Your browser does not support the HTML5 canvas tag.</canvas>
<canvas id="imageCanvas" width="580" height="580" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
<canvas id="histogramldr" width="256" height="300" style="border:1px solid #d3d3d3; vertical-align: top;">
Your browser does not support the HTML5 canvas tag.</canvas>
</div>

<script src="targetData.js"></script>
<script type="text/javascript">

var cHisthdr = document.getElementById("histogramhdr");
var ctxHisthdr = cHisthdr.getContext("2d");
var cHistldr = document.getElementById("histogramldr");
var ctxHistldr = cHistldr.getContext("2d");
var c = document.getElementById("imageCanvas");
var ctx = c.getContext("2d");

var min = 1.7976931348623157E+10308; // Infinity
var max = -1.7976931348623157E+10308; // -Infinity


Math.clip = function(number, min, max) {
  return Math.max(min, Math.min(number, max));
}

function log10(val) {
  return Math.log(val) / Math.LN10;
}

function linear(src, dst, min, max) {
    var range = max - min;
    for (i = 0; i < src.length; i++) {
        if (i % 4 == 3) { dst[i] = 255; continue; } // Do not modify alpha
        v = Math.clip((src[i] - min) / range, 0, range);
        dst[i] = Math.clip(v * 255, 0, 255);
    }
}

function gamma20(src, dst, min, max) {
    var range = max - min;
    for (i = 0; i < src.length; i++) {
        if (i % 4 == 3) { dst[i] = 255; continue; } // Do not modify alpha
        v = src[i] - min;
        dst[i] = Math.clip(255 * Math.pow(v, 1/2.0), 0, 255);
    }
}

function reinhart2002(src, dst, min, max) {
    for (i = 0; i < src.length; i++) {
        if (i % 4 == 3) { dst[i] = 255; continue; } // Do not modify alpha
        v = src[i];
        dst[i] = Math.clip((v / (1 + v)) * 255, 0, 255);
    }
}


function array256(default_value) {
  arr = [];
  for (var i=0; i<256; i++) { arr[i] = default_value; }
  return arr;
}

function refreshHDRHistogram() {
    var bin_size = Math.round((max - min) / 256);
    var rvals = array256(0);
    var gvals = array256(0);
    var bvals = array256(0);
    
    // Taken from here: http://billmill.org/the_histogram.html
    for (i = 0; i < targetData.length; i+=4) {
        rvals[Math.round((targetData[i + 0] - min) / bin_size)]++;
        gvals[Math.round((targetData[i + 1] - min) / bin_size)]++;
        bvals[Math.round((targetData[i + 2] - min) / bin_size)]++;
    }
    //get a reference to the canvas to draw on
    var rmax = Math.max.apply(null, rvals);
    var bmax = Math.max.apply(null, bvals);
    var gmax = Math.max.apply(null, gvals);

    // Clear canvas
    ctxHisthdr.clearRect(0, 0, cHistldr.width, cHistldr.height);

    function colorbars(max, vals, color, y) {
        ctxHisthdr.fillStyle = color;
        jQuery.each(vals, function(i,x) {
            var pct = (vals[i] / max) * 20;
            ctxHisthdr.fillRect(i, y, 1, -Math.round(pct));
        });
    }

    colorbars(rmax, rvals, "rgb(255,0,0)", 20);
    colorbars(gmax, gvals, "rgb(0,255,0)", 40);
    colorbars(bmax, bvals, "rgb(0,0,255)", 60);    
}

function refreshLDRHistogram() {
    var imgData = ctx.getImageData(0, 0, 580, 580);
    var rvals = array256(0);
    var gvals = array256(0);
    var bvals = array256(0);
    
    // Taken from here: http://billmill.org/the_histogram.html
    for (i = 0; i < imgData.data.length; i+=4) {
        if ($("#rmz").is(':checked') && imgData.data[i + 0] + imgData.data[i + 1] + imgData.data[i + 2] == 0) { continue; }
        rvals[imgData.data[i + 0]]++;
        gvals[imgData.data[i + 1]]++;
        bvals[imgData.data[i + 2]]++;
    }
    //get a reference to the canvas to draw on
    var rmax = Math.max.apply(null, rvals);
    var bmax = Math.max.apply(null, bvals);
    var gmax = Math.max.apply(null, gvals);

    // Clear canvas
    ctxHistldr.clearRect(0, 0, cHistldr.width, cHistldr.height);

    function colorbars(max, vals, color, y) {
        ctxHistldr.fillStyle = color;
        jQuery.each(vals, function(i,x) {
            var pct = (vals[i] / max) * 100;
            ctxHistldr.fillRect(i, y, 1, -Math.round(pct));
        });
    }

    colorbars(rmax, rvals, "rgb(255,0,0)", 100);
    colorbars(gmax, gvals, "rgb(0,255,0)", 200);
    colorbars(bmax, bvals, "rgb(0,0,255)", 300);    
}

function displayImage() {
    var imgData = ctx.getImageData(0, 0, 580, 580);
    var values = $('#slider').slider("values");
    var sliderMinVal = Math.pow(10, values[0] / 100. * log10((max - min))) - 1 + min;
    var sliderMaxVal = Math.pow(10, values[1] / 100. * log10((max - min))) - 0 + min;
    var sliderRange = sliderMaxVal - sliderMinVal;
    console.log(min, sliderMinVal);
    console.log(max, sliderMaxVal);
    var v;
    var hdr_opt = $("#hdr_select option:selected").val();
    if (hdr_opt == "lin") {
        linear(targetData, imgData.data, sliderMinVal, sliderMaxVal);
    } else if (hdr_opt == "gamma20") {
        gamma20(targetData, imgData.data, sliderMinVal, sliderMaxVal);
    } else if (hdr_opt == "reinhart2002") {
        reinhart2002(targetData, imgData.data, sliderMinVal, sliderMaxVal);
    }
    ctx.putImageData(imgData, 0, 0);
    refreshLDRHistogram();
}

$(function(){
    // TODO: If max is < 1, max will be 1 because of data.
    //       Likewise for min
    for (i = 0; i < targetData.length; i++) {
        if (targetData[i] < min) { min = targetData[i]; }
        if (targetData[i] > max) { max = targetData[i]; }
    }

    $('#slider').slider({
        animate: true,
        range: true,
        rangeDrag: true,
        values: [30, 70],
        change: function(event, ui) {
            displayImage();
        }
    });

    $( "#hdr_select" ).change(function() {
        var hdr_opt = $("#hdr_select option:selected").val();
        if (hdr_opt == "reinhart2002") {
            $("#slider").slider("option", "values", [0, 100]);
        } else {
            $("#slider").slider("option", "values", [30, 70]);
        }
        displayImage();
    });

    $( "#rmz" ).change(function() {
        refreshLDRHistogram();
    });    

    displayImage();
    refreshHDRHistogram();
});
</script>

</body>
</html>
